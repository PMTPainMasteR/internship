name: Build, Scan, and AI Analysis

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  docker-build-run:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: .trivy          # Fixed typo: .triy -> .trivy
          key: ${{ runner.os }}-trivy-db
          restore-keys: |
            ${{ runner.os }}-trivy-db

      - name: Build Docker Image
        uses: docker/build-push-action@v6
        with:
          context: ./app
          tags: wifi-simulation:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # --- SCAN 1: BLOCKING (Must fail to trigger AI) ---
      - name: Docker Image Scaned by Trivy
        id: trivy_scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'wifi-simulation:latest'
          format: 'table'
          exit-code: '1'        # FIXED: Must be '1' to trigger failure() steps
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH,MEDIUM'
          cache-dir: .trivy

      # --- SCAN 2: REPORTING ---
      - name: Generate JSON Report
        if: failure() && steps.trivy_scan.outcome == 'failure'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'wifi-simulation:latest'
          format: 'json'
          output: 'trivy-report.json' # Fixed typo: trivt -> trivy
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH,MEDIUM'
          cache-dir: .trivy
      
      # --- AI ANALYSIS STEP ---
      - name: Analyze by AI
        if: failure() && steps.trivy_scan.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GH_MODELS_API_KEY }}
        run: |
          echo "Processing Trivy Report..."

          # 1. Extract and Filter Data
          REPORT_CONTENT=$(jq -c '
          [
            .Results[]? | .Vulnerabilities[]?
            | { Package: .PkgName, Current: .InstalledVersion, FixedIn: .FixedVersion, ID: .VulnerabilityID }
          ]
          | unique_by(.Package) | .[:20]' trivy-report.json)

          # 2. Safety Check
          if [ -z "$REPORT_CONTENT" ] || [ "$REPORT_CONTENT" == "[]" ]; then 
            echo "No vulnerabilities found to send"
            exit 0
          fi

          # 3. Build Payload (Safe from Injection)
          jq -n \
            --arg report "$REPORT_CONTENT" \
            '{
              model: "gpt-4o",
              max_tokens: 1500,  # <--- Increased to prevent cutoff
              messages: [
                {
                  role: "system",
                  content: "You are a DevSecOps expert. Provide the exact fix commands (e.g., apt-get install) for these vulnerabilities. Format the output using Markdown."
                },
                {
                  role: "user",
                  content: ("Fix these issues: " + $report)
                }
              ]
            }' > payload.json

            echo "Sending request to AI..."

            curl https://models.inference.ai.azure.com/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              -d @payload.json \
              -o ai_response.json

            # 4. PRINT CLEAN OUTPUT (The Fix for \n)
            echo "---------------------------------------------------"
            echo "AI REMEDIATION ADVICE:"
            echo "---------------------------------------------------"
            
            # The -r flag tells jq to render \n as real newlines
            cat ai_response.json | jq -r '.choices[0].message.content'

            # 5. BONUS: Add to GitHub Summary Page
            echo "## ðŸ›¡ï¸ AI Security Remediation" >> $GITHUB_STEP_SUMMARY
            cat ai_response.json | jq -r '.choices[0].message.content' >> $GITHUB_STEP_SUMMARY

      # Only run simulation if everything passed (optional)
      - name: Run Simulation
        if: success()
        run: docker run --rm wifi-simulation:latest
