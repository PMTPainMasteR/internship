name: Build, Scan, and AI Analysis

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  docker-build-run:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: .trivy          # Fixed typo: .triy -> .trivy
          key: ${{ runner.os }}-trivy-db
          restore-keys: |
            ${{ runner.os }}-trivy-db

      - name: Build Docker Image
        uses: docker/build-push-action@v6
        with:
          context: ./app
          tags: wifi-simulation:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # --- SCAN 1: BLOCKING (Must fail to trigger AI) ---
      - name: Docker Image Scaned by Trivy
        id: trivy_scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'wifi-simulation:latest'
          format: 'table'
          exit-code: '1'        # FIXED: Must be '1' to trigger failure() steps
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH,MEDIUM'
          cache-dir: .trivy

      # --- SCAN 2: REPORTING ---
      - name: Generate JSON Report
        if: failure() && steps.trivy_scan.outcome == 'failure'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'wifi-simulation:latest'
          format: 'json'
          output: 'trivy-report.json' # Fixed typo: trivt -> trivy
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH,MEDIUM'
          cache-dir: .trivy
      
      # --- AI ANALYSIS STEP ---
      - name: Analyze by AI
        if: failure() && steps.trivy_scan.outcome == 'failure'
        env:
          # FIXED: Use your custom secret, not the default GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Processing Trivy Report..."

          # Extract data using jq
          REPORT_CONTENT=$(jq -c '
          [
            .Results[]? | .Vulnerabilities[]?
            | { Package: .PkgName, Current: .InstalledVersion, FixedIn: .FixedVersion, ID: .VulnerabilityID }
          ]
          | unique_by(.Package) | .[:20]' trivy-report.json)

          # Check if report is empty
          if [ -z "$REPORT_CONTENT" ] || [ "$REPORT_CONTENT" == "[]" ]; then 
            echo "No vulnerabilities found to send"
            exit 0
          fi

          # Construct Payload
          jq -n \
            --arg report "$REPORT_CONTENT" \
            '{
              model: "gpt-4o",          # Fixed typo: gpt-40 -> gpt-4o
              messages: [               # Fixed typo: message -> messages
                {
                  role: "system",
                  content: "You are a DevSecOps expert. Provide the exact fix commands (e.g., apt-get install) for these vulnerabilities."
                },
                {
                  role: "user",
                  content: ("Fix these issues: " + $report)
                }
              ]
            }' > payload.json

            echo "Sending request to AI..."

            curl https://models.inference.ai.azure.com/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              -d @payload.json \
              -o ai_response.json

            echo "---DEBUG: RAW AI RESPONSE ---"
            cat ai_response.json
            echo "-----------------------------"

            # echo "AI REMEDIATION ADVICE:" 
            # cat ai_response.json | jq -r '.choices[0].message.content'

      # Only run simulation if everything passed (optional)
      - name: Run Simulation
        if: success()
        run: docker run --rm wifi-simulation:latest
